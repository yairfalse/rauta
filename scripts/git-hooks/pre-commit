#!/bin/bash
# Pre-commit hook to enforce code quality before committing
# This catches issues locally before wasting CI minutes

set -e

echo "🔍 Running pre-commit checks..."

# Get list of staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -z "$STAGED_RS_FILES" ]; then
    echo "✅ No Rust files to check"
    exit 0
fi

# Track if any checks failed
CHECKS_FAILED=0

# =============================================================================
# CHECK 1: No unwrap()/expect()/panic!() in production code
# =============================================================================
echo ""
echo "📋 [1/4] Checking for unwrap()/expect()/panic!() in production code..."

VIOLATIONS_FOUND=0

for FILE in $STAGED_RS_FILES; do
    # Skip test directories and test files
    if echo "$FILE" | grep -qE '(tests/|_test\.rs$|common/tests/)'; then
        continue
    fi

    # Check for .unwrap() outside test modules
    UNWRAP_LINES=$(grep -n '\.unwrap()' "$FILE" 2>/dev/null | grep -v '^\s*//' | grep -v '^\s*\*' || true)
    if [ -n "$UNWRAP_LINES" ]; then
        if ! grep -q '#\[cfg(test)\]' "$FILE" 2>/dev/null; then
            echo "  ❌ Found .unwrap() in production code in $FILE"
            VIOLATIONS_FOUND=1
        fi
    fi

    # Check for .expect() outside test modules
    EXPECT_LINES=$(grep -n '\.expect(' "$FILE" 2>/dev/null | grep -v '^\s*//' | grep -v '^\s*\*' || true)
    if [ -n "$EXPECT_LINES" ]; then
        if ! grep -q '#\[cfg(test)\]' "$FILE" 2>/dev/null; then
            # Allow .expect() in lazy_static blocks for fallback metrics
            if ! grep -q 'lazy_static!' "$FILE" 2>/dev/null; then
                echo "  ❌ Found .expect() in production code in $FILE"
                VIOLATIONS_FOUND=1
            fi
        fi
    fi

    # Check for panic!() outside test modules
    PANIC_LINES=$(grep -n 'panic!(' "$FILE" 2>/dev/null | grep -v '^\s*//' | grep -v '^\s*\*' | grep -v '//.*panic!' || true)
    if [ -n "$PANIC_LINES" ]; then
        if ! grep -q '#\[cfg(test)\]' "$FILE" 2>/dev/null; then
            if ! echo "$PANIC_LINES" | grep -q '//.*panic!'; then
                echo "  ❌ Found panic!() in production code in $FILE"
                VIOLATIONS_FOUND=1
            fi
        fi
    fi
done

if [ $VIOLATIONS_FOUND -eq 1 ]; then
    echo "  🚫 FAILED: Production code contains unwrap()/expect()/panic!()"
    echo "     Use safe_read/safe_write/safe_lock for locks"
    echo "     Use proper error handling (Result/Option)"
    CHECKS_FAILED=1
else
    echo "  ✅ PASSED"
fi

# =============================================================================
# CHECK 2: Cargo fmt (formatting)
# =============================================================================
echo ""
echo "📋 [2/4] Checking code formatting..."

if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "  ❌ FAILED: Code is not formatted"
    echo "     Run: cargo fmt --all"
    CHECKS_FAILED=1
else
    echo "  ✅ PASSED"
fi

# =============================================================================
# CHECK 3: Cargo clippy (lints) - FAST CHECK ONLY
# =============================================================================
echo ""
echo "📋 [3/4] Running clippy (warnings only, fast)..."

# Only check the staged files' workspaces
CLIPPY_FAILED=0

if echo "$STAGED_RS_FILES" | grep -q '^common/'; then
    if ! cargo clippy --manifest-path common/Cargo.toml --all-targets -- -D warnings 2>&1 | grep -v "Checking\|Finished" | head -20; then
        CLIPPY_FAILED=1
    fi
fi

if echo "$STAGED_RS_FILES" | grep -q '^control/'; then
    if ! cargo clippy --manifest-path control/Cargo.toml --all-targets -- -D warnings 2>&1 | grep -v "Checking\|Finished" | head -20; then
        CLIPPY_FAILED=1
    fi
fi

if [ $CLIPPY_FAILED -eq 1 ]; then
    echo "  ❌ FAILED: Clippy warnings found"
    echo "     Run: cargo clippy --fix"
    CHECKS_FAILED=1
else
    echo "  ✅ PASSED"
fi

# =============================================================================
# CHECK 4: Cargo check (compilation) - FAST CHECK ONLY
# =============================================================================
echo ""
echo "📋 [4/4] Checking compilation (cargo check)..."

CHECK_FAILED=0

if echo "$STAGED_RS_FILES" | grep -q '^common/'; then
    if ! cargo check --manifest-path common/Cargo.toml > /dev/null 2>&1; then
        CHECK_FAILED=1
    fi
fi

if echo "$STAGED_RS_FILES" | grep -q '^control/'; then
    if ! cargo check --manifest-path control/Cargo.toml > /dev/null 2>&1; then
        CHECK_FAILED=1
    fi
fi

if [ $CHECK_FAILED -eq 1 ]; then
    echo "  ❌ FAILED: Code does not compile"
    echo "     Run: cargo check"
    CHECKS_FAILED=1
else
    echo "  ✅ PASSED"
fi

# =============================================================================
# FINAL RESULT
# =============================================================================
echo ""
echo "════════════════════════════════════════════════════════════════"

if [ $CHECKS_FAILED -eq 1 ]; then
    echo "🚫 PRE-COMMIT CHECKS FAILED"
    echo ""
    echo "Fix the issues above or skip with: git commit --no-verify"
    echo "════════════════════════════════════════════════════════════════"
    exit 1
fi

echo "✅ ALL PRE-COMMIT CHECKS PASSED"
echo "════════════════════════════════════════════════════════════════"
exit 0
