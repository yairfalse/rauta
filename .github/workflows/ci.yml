name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0  # Faster CI builds

jobs:
  # Path filtering - skip if only docs changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
              - '.github/workflows/ci.yml'

  # Standard Rust CI - uses shared tooling
  format:
    name: Format
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: yairfalse/.github/.github/actions/setup-rust@main
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: yairfalse/.github/.github/actions/setup-rust@main
      - run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: yairfalse/.github/.github/actions/setup-rust@main
      - run: cargo test --all-features --verbose

  # Integration tests with Kind + Gateway API
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [changes, format, clippy, test]
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: yairfalse/.github/.github/actions/setup-rust@main

      - uses: yairfalse/.github/.github/actions/setup-kind@main
        with:
          cluster-name: rauta-test
          install-gateway-api: 'true'

      - name: Run integration tests
        run: cargo test --all-features -- --ignored

      - name: Cleanup
        if: always()
        run: kind delete cluster --name rauta-test

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: yairfalse/.github/.github/actions/setup-rust@main
      - run: cargo install cargo-audit
      - run: cargo audit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [format, clippy, test]
    if: needs.test.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: yairfalse/.github/.github/actions/setup-rust@main
      - run: cargo build --release --all-features
      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: target/release/rauta
          retention-days: 7

  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [format, clippy, test, integration, security, build]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.format.result }}" == "failure" ] || \
             [ "${{ needs.clippy.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.integration.result }}" == "failure" ] || \
             [ "${{ needs.security.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ]; then
            echo "❌ CI failed"
            exit 1
          fi
          echo "✅ All checks passed"
